// auth-ui.js
(function(){
  const authArea = document.getElementById('auth-area');
  const loginBtnHTML = '<button id="loginBtn" class="btn">تسجيل / دخول</button>';
  const userTpl = document.getElementById('userDropdownTpl');

  function getToken() {
    return localStorage.getItem('authToken'); // أو استبداله بآلية الكوكيز
  }

  function isAuthenticated() {
    const t = getToken();
    // اختياري: تحقق انتهاء الصلاحية إذا كان التوكن يحمل exp
    return !!t;
  }

  function renderAuthArea() {
    authArea.innerHTML = '';
    if (!isAuthenticated()) {
      authArea.insertAdjacentHTML('beforeend', loginBtnHTML);
      const btn = document.getElementById('loginBtn');
      if (btn) btn.addEventListener('click', () => {
        // توجيه لصفحة تسجيل الدخول أو إظهار مودال
        window.location.href = '/login.html';
      });
    } else {
      const clone = userTpl.content.cloneNode(true);
      authArea.appendChild(clone);
      const userDropdown = authArea.querySelector('.user-dropdown');
      const toggle = document.getElementById('userToggle');
      const menu = document.getElementById('userMenu');
      toggle.addEventListener('click', (e) => {
        userDropdown.classList.toggle('show');
      });
      document.addEventListener('click', (e) => {
        if (!userDropdown.contains(e.target)) userDropdown.classList.remove('show');
      });

      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.addEventListener('click', logout);
    }
  }

  function logout() {
    // إن كان هناك API ختمة جلسة: اطلب /logout ثم امسح التخزين
    // مثال:
    fetch('/api/logout', { method: 'POST', credentials: 'include' }).catch(()=>{});
    localStorage.removeItem('authToken');
    // إعادة توجيه أو تحديث الواجهة
    window.location.href = '/';
  }

  // استدعاء عند التحميل
  document.addEventListener('DOMContentLoaded', renderAuthArea);
})();

/* CSS مبسّط للdropdown */
.user-dropdown { position: relative; display: inline-block; }
.user-toggle { background: none; border: none; cursor: pointer; padding: 6px 10px; }
.user-icon { width:20px; height:20px; vertical-align: middle; margin-right:6px; }

.dropdown-menu {
  display: none;
  position: absolute;
  right: 0;
  background: #fff;
  border: 1px solid #ddd;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  min-width: 180px;
  z-index: 1000;
}
.user-dropdown.show .dropdown-menu { display: block; }
.dropdown-menu a, .dropdown-menu button {
  display: block; width:100%; padding:8px 12px; text-align:left; border:none; background:none; cursor:pointer;
}
.dropdown-menu hr { margin: 6px 0; border: none; border-top: 1px solid #eee; }

<!-- HTML: navbar (ضع في ملف الهيدر) -->
<nav class="navbar">
  <a href="/" class="brand">FastShip</a>

  <div id="nav-right">
    <div id="auth-area">
      <!-- هذا المحتوى يتبدّل عبر JS بناءً على حالة المصادقة -->
      <button id="loginBtn" class="btn">تسجيل / دخول</button>
    </div>
  </div>
</nav>

<!-- Dropdown template (سيُستخدم عند المصادقة) -->
<template id="userDropdownTpl">
  <div class="user-dropdown">
    <button class="user-toggle" id="userToggle">
      <img src="/assets/user-icon.svg" alt="user" class="user-icon"> حسابي
    </button>
    <div class="dropdown-menu" id="userMenu">
      <a href="/dashboard.html">لوحة التحكم</a>
      <a href="/profile.html">الملف الشخصي</a>
      <a href="/orders.html">الطلبات</a>
      <!-- أضف خصائص أخرى حسب الحاجة -->
      <hr>
      <button id="logoutBtn" class="btn-logout">تسجيل الخروج</button>
    </div>
  </div>
</template>