<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فحص إعدادات Supabase - Supabase Configuration Check</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            direction: rtl; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 30px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: #fafafa;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .table-check {
            margin: 10px 0;
            border-collapse: collapse;
            width: 100%;
        }
        .table-check th, .table-check td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        .table-check th { background: #f8f9fa; }
        
        .check-icon { font-size: 18px; margin-left: 10px; }
        .check-success { color: #28a745; }
        .check-error { color: #dc3545; }
        .check-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-database"></i> فحص شامل لإعدادات Supabase</h1>
        <p>هذه الصفحة ستفحص جميع إعدادات Supabase المطلوبة لعمل الموقع بشكل صحيح</p>
        
        <div class="test-section">
            <h2>1. فحص الاتصال الأساسي</h2>
            <button onclick="checkBasicConnection()">فحص الاتصال</button>
            <div class="result" id="connectionResult">
                اضغط على "فحص الاتصال" لبدء الفحص
            </div>
        </div>
        
        <div class="test-section">
            <h2>2. فحص المصادقة والجلسة</h2>
            <button onclick="checkAuthentication()">فحص المصادقة</button>
            <div class="result" id="authResult">
                اضغط لفحص حالة المصادقة الحالية
            </div>
        </div>
        
        <div class="test-section">
            <h2>3. فحص الجداول المطلوبة</h2>
            <button onclick="checkTables()">فحص الجداول</button>
            <div class="result" id="tablesResult">
                سيتم فحص وجود جميع الجداول المطلوبة
            </div>
        </div>
        
        <div class="test-section">
            <h2>4. فحص Row Level Security (RLS)</h2>
            <button onclick="checkRLS()">فحص RLS</button>
            <div class="result" id="rlsResult">
                سيتم فحص إعدادات الأمان للجداول
            </div>
        </div>
        
        <div class="test-section">
            <h2>5. فحص الملف الشخصي للمستخدم</h2>
            <button onclick="checkUserProfile()">فحص الملف الشخصي</button>
            <div class="result" id="profileResult">
                سيتم فحص وجود الملف الشخصي للمستخدم الحالي
            </div>
        </div>
        
        <div class="test-section">
            <h2>6. اختبار العمليات الأساسية</h2>
            <button onclick="testBasicOperations()">اختبار العمليات</button>
            <div class="result" id="operationsResult">
                سيتم اختبار قراءة وكتابة البيانات
            </div>
        </div>
        
        <div class="test-section">
            <h2>7. تشخيص المشاكل المحتملة</h2>
            <button onclick="diagnoseIssues()">تشخيص المشاكل</button>
            <div class="result" id="diagnosisResult">
                سيتم البحث عن المشاكل الشائعة وحلولها
            </div>
        </div>
        
        <div class="test-section">
            <h2>8. معلومات النظام</h2>
            <button onclick="showSystemInfo()">عرض معلومات النظام</button>
            <div class="result" id="systemResult">
                معلومات تفصيلية عن إعدادات النظام
            </div>
        </div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://chmistqmcmmmjqeanudu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNobWlzdHFtY21tbWpxZWFudWR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NDg1MTEsImV4cCI6MjA3NjIyNDUxMX0.Ho-3nEs3_w5Xmna2z0HQF6dDjh8MkiBzD10N_6vuEKs';
        
        let supabaseClient;
        
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase client initialized');
        } catch (error) {
            console.error('Failed to initialize Supabase:', error);
        }
        
        function showResult(elementId, type, message, details = '') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle check-success' : 
                              type === 'error' ? 'fa-times-circle check-error' : 
                              'fa-exclamation-triangle check-warning'}"></i>
                ${message}
                ${details ? `<div class="code-block">${details}</div>` : ''}
            `;
        }
        
        async function checkBasicConnection() {
            try {
                showResult('connectionResult', 'info', 'جاري فحص الاتصال...');
                
                if (!supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                // Test basic connection
                const { data, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    throw error;
                }
                
                // Test a simple query
                const { data: testData, error: queryError } = await supabaseClient
                    .from('users')
                    .select('count', { count: 'exact' })
                    .limit(1);
                
                if (queryError) {
                    throw queryError;
                }
                
                showResult('connectionResult', 'success', 
                    'الاتصال بـ Supabase تم بنجاح ✅', 
                    `URL: ${SUPABASE_URL}<br>عدد المستخدمين: ${testData?.length || 0}`
                );
                
            } catch (error) {
                showResult('connectionResult', 'error', 
                    'فشل الاتصال بـ Supabase ❌', 
                    `خطأ: ${error.message}`
                );
            }
        }
        
        async function checkAuthentication() {
            try {
                showResult('authResult', 'info', 'جاري فحص المصادقة...');
                
                const { data: session, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    throw error;
                }
                
                if (session.session) {
                    const user = session.session.user;
                    showResult('authResult', 'success', 
                        'المستخدم مسجل دخول ✅', 
                        `البريد الإلكتروني: ${user.email}<br>ID: ${user.id}<br>تاريخ آخر تسجيل دخول: ${new Date(user.last_sign_in_at).toLocaleString('ar')}`
                    );
                } else {
                    showResult('authResult', 'warning', 
                        'لا يوجد مستخدم مسجل دخول ⚠️', 
                        'هذا قد يكون سبب المشاكل في الوصول للصفحات المحمية'
                    );
                }
                
            } catch (error) {
                showResult('authResult', 'error', 
                    'خطأ في فحص المصادقة ❌', 
                    `خطأ: ${error.message}`
                );
            }
        }
        
        async function checkTables() {
            showResult('tablesResult', 'info', 'جاري فحص الجداول...');
            
            const requiredTables = [
                'users', 'trips', 'shipments', 'matches', 
                'messages', 'reviews', 'notifications', 'cities'
            ];
            
            let results = '<table class="table-check"><tr><th>اسم الجدول</th><th>الحالة</th><th>عدد السجلات</th></tr>';
            let allTablesExist = true;
            
            for (const table of requiredTables) {
                try {
                    const { data, error, count } = await supabaseClient
                        .from(table)
                        .select('*', { count: 'exact' })
                        .limit(1);
                    
                    if (error) {
                        results += `<tr><td>${table}</td><td><i class="fas fa-times check-error"></i> غير موجود</td><td>-</td></tr>`;
                        allTablesExist = false;
                    } else {
                        results += `<tr><td>${table}</td><td><i class="fas fa-check check-success"></i> موجود</td><td>${count || 0}</td></tr>`;
                    }
                } catch (e) {
                    results += `<tr><td>${table}</td><td><i class="fas fa-times check-error"></i> خطأ</td><td>-</td></tr>`;
                    allTablesExist = false;
                }
            }
            
            results += '</table>';
            
            if (allTablesExist) {
                showResult('tablesResult', 'success', 'جميع الجداول المطلوبة موجودة ✅', results);
            } else {
                showResult('tablesResult', 'error', 'بعض الجداول مفقودة ❌', 
                    results + '<br><strong>الحل:</strong> قم بتشغيل ملف supabase-tables.sql في Supabase SQL Editor');
            }
        }
        
        async function checkRLS() {
            showResult('rlsResult', 'info', 'جاري فحص إعدادات RLS...');
            
            try {
                // Try to access users table (should work with RLS)
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('id')
                    .limit(1);
                
                if (error && error.message.includes('permission denied')) {
                    showResult('rlsResult', 'error', 
                        'مشكلة في إعدادات RLS ❌', 
                        'Row Level Security مفعل لكن السياسات غير صحيحة<br><strong>الحل:</strong> تحقق من policies في Supabase Dashboard'
                    );
                } else if (error) {
                    throw error;
                } else {
                    showResult('rlsResult', 'success', 
                        'إعدادات RLS تعمل بشكل صحيح ✅', 
                        'يمكن الوصول للجداول بالصلاحيات المناسبة'
                    );
                }
                
            } catch (error) {
                showResult('rlsResult', 'error', 
                    'خطأ في فحص RLS ❌', 
                    `خطأ: ${error.message}`
                );
            }
        }
        
        async function checkUserProfile() {
            try {
                showResult('profileResult', 'info', 'جاري فحص الملف الشخصي...');
                
                const { data: session } = await supabaseClient.auth.getSession();
                
                if (!session.session) {
                    showResult('profileResult', 'warning', 
                        'لا يوجد مستخدم مسجل دخول ⚠️', 
                        'يجب تسجيل الدخول أولاً لفحص الملف الشخصي'
                    );
                    return;
                }
                
                const { data: profile, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('auth_user_id', session.session.user.id)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        showResult('profileResult', 'error', 
                            'الملف الشخصي غير موجود ❌', 
                            'هذا هو السبب الأساسي للمشاكل!<br><strong>الحل:</strong> يجب إنشاء الملف الشخصي في جدول users'
                        );
                    } else {
                        throw error;
                    }
                } else {
                    showResult('profileResult', 'success', 
                        'الملف الشخصي موجود ✅', 
                        `الاسم: ${profile.name}<br>النوع: ${profile.user_type}<br>الحالة: ${profile.verification_status}`
                    );
                }
                
            } catch (error) {
                showResult('profileResult', 'error', 
                    'خطأ في فحص الملف الشخصي ❌', 
                    `خطأ: ${error.message}`
                );
            }
        }
        
        async function testBasicOperations() {
            try {
                showResult('operationsResult', 'info', 'جاري اختبار العمليات...');
                
                // Test reading cities (should be public)
                const { data: cities, error: citiesError } = await supabaseClient
                    .from('cities')
                    .select('name_ar')
                    .limit(5);
                
                if (citiesError) {
                    throw citiesError;
                }
                
                // Test reading users (depends on session)
                const { data: users, error: usersError } = await supabaseClient
                    .from('users')
                    .select('name')
                    .limit(5);
                
                let operationsText = `قراءة المدن: نجح (${cities?.length || 0} مدن)<br>`;
                
                if (usersError) {
                    operationsText += `قراءة المستخدمين: فشل (${usersError.message})<br>`;
                } else {
                    operationsText += `قراءة المستخدمين: نجح (${users?.length || 0} مستخدمين)<br>`;
                }
                
                showResult('operationsResult', 'success', 
                    'اختبار العمليات الأساسية ✅', 
                    operationsText
                );
                
            } catch (error) {
                showResult('operationsResult', 'error', 
                    'فشل في اختبار العمليات ❌', 
                    `خطأ: ${error.message}`
                );
            }
        }
        
        async function diagnoseIssues() {
            showResult('diagnosisResult', 'info', 'جاري تشخيص المشاكل...');
            
            let issues = [];
            let solutions = [];
            
            // Check session storage
            const storedUser = sessionStorage.getItem('user_email');
            const storedType = sessionStorage.getItem('user_type');
            
            if (!storedUser || !storedType) {
                issues.push('❌ بيانات الجلسة مفقودة من sessionStorage');
                solutions.push('سجل خروج ثم دخول مرة أخرى');
            }
            
            // Check Supabase session
            const { data: session } = await supabaseClient.auth.getSession();
            if (!session.session) {
                issues.push('❌ لا توجد جلسة نشطة في Supabase');
                solutions.push('قم بتسجيل الدخول مرة أخرى');
            }
            
            // Check user profile
            if (session.session) {
                try {
                    const { data: profile, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('auth_user_id', session.session.user.id)
                        .single();
                    
                    if (error || !profile) {
                        issues.push('❌ الملف الشخصي غير موجود في قاعدة البيانات');
                        solutions.push('قم بإنشاء الملف الشخصي في جدول users أو سجل حساب جديد');
                    }
                } catch (e) {
                    issues.push('❌ خطأ في الوصول للملف الشخصي');
                    solutions.push('تحقق من إعدادات RLS في Supabase');
                }
            }
            
            if (issues.length === 0) {
                showResult('diagnosisResult', 'success', 
                    'لم يتم العثور على مشاكل واضحة ✅', 
                    'جميع الفحوصات الأساسية تبدو سليمة'
                );
            } else {
                showResult('diagnosisResult', 'error', 
                    'تم العثور على مشاكل ❌', 
                    '<strong>المشاكل:</strong><br>' + issues.join('<br>') + 
                    '<br><br><strong>الحلول المقترحة:</strong><br>' + solutions.join('<br>')
                );
            }
        }
        
        function showSystemInfo() {
            const info = `
                <strong>معلومات Supabase:</strong><br>
                URL: ${SUPABASE_URL}<br>
                Project ID: ${SUPABASE_URL.split('//')[1].split('.')[0]}<br>
                <br>
                <strong>معلومات المتصفح:</strong><br>
                User Agent: ${navigator.userAgent}<br>
                اللغة: ${navigator.language}<br>
                الوقت المحلي: ${new Date().toLocaleString('ar')}<br>
                <br>
                <strong>Session Storage:</strong><br>
                user_email: ${sessionStorage.getItem('user_email') || 'غير موجود'}<br>
                user_type: ${sessionStorage.getItem('user_type') || 'غير موجود'}<br>
                user_id: ${sessionStorage.getItem('user_id') || 'غير موجود'}<br>
                <br>
                <strong>إعدادات أخرى:</strong><br>
                الصفحة الحالية: ${window.location.href}<br>
                Referrer: ${document.referrer || 'مباشر'}<br>
            `;
            
            showResult('systemResult', 'info', 'معلومات النظام', info);
        }
        
        // Auto-run basic checks on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkBasicConnection();
            }, 1000);
        });
    </script>
</body>
</html>