# ๐ฌ ูุธุงู ุงูุฏุฑุฏุดุฉ ุงูููุฑูุฉ - Fast Ship SA
## Real-time Chat System Documentation

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุฏุฑุฏุดุฉ ููุฑู ูุชูุงูู ูุณุชุฎุฏู **Supabase Realtime** ูุชูููุฑ ุชุฌุฑุจุฉ ูุฑุงุณูุฉ ุณูุณุฉ ุจูู ุงููุงูููู ูุฃุตุญุงุจ ุงูุดุญูุงุช.

### โจ ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

- โ **ุฑุณุงุฆู ููุฑูุฉ** - ุชุญุฏูุซุงุช ูุญุธูุฉ ุจุงุณุชุฎุฏุงู Supabase Realtime
- โ **ูุคุดุฑุงุช ุงูุงุชุตุงู** - ูุนุฑูุฉ ูู ูุชุตู ุงูุขู
- โ **ุฅุดุนุงุฑุงุช ุงููุฑุงุกุฉ** - ุนูุงูุฉ ุงูุตุญ ุงููุฒุฏูุฌุฉ ุนูุฏ ุงููุฑุงุกุฉ
- โ **ุฅุดุนุงุฑุงุช ุงููุชุตูุญ** - ุชูุจููุงุช ููุฑุณุงุฆู ุงูุฌุฏูุฏุฉ
- โ **ุจุญุซ ูู ุงููุญุงุฏุซุงุช** - ุฅูุฌุงุฏ ูุญุงุฏุซุงุช ูุญุฏุฏุฉ ุจุณุฑุนุฉ
- โ **ุชูุงูู WhatsApp** - ุงูุชูุงู ุณุฑูุน ูููุญุงุฏุซุฉ ุนุจุฑ ูุงุชุณุงุจ
- โ **ุงุชุตุงู ูุงุชูู ูุจุงุดุฑ** - ุฒุฑ ููุงุชุตุงู ุงูููุฑู
- โ **ุชุตููู ูุชุฌุงูุจ** - ูุนูู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ

---

## ๐ ุงูุชุซุจูุช ูุงูุฅุนุฏุงุฏ

### ุงูุฎุทูุฉ 1: ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช

ูู ุจุชูููุฐ ุงูุณูุฑุจุช SQL ูู Supabase:

```bash
# ูู Supabase Dashboard:
# 1. ุงุฐูุจ ุฅูู SQL Editor
# 2. ุงูุณุฎ ูุญุชูู ููู update-messages-table.sql
# 3. ููุฐ ุงูุณูุฑุจุช
```

ุฃู ุนุจุฑ CLI:

```bash
supabase db push --file ./utils/update-messages-table.sql
```

### ุงูุฎุทูุฉ 2: ุชูุนูู Realtime ูู Supabase

1. ุงุฐูุจ ุฅูู **Database** โ **Replication**
2. ูู ุจุชูุนูู Realtime ููุฌุฏูู `messages`
3. ุญุฏุฏ ุงูุฃุนูุฏุฉ: `id`, `sender_id`, `receiver_id`, `match_id`, `content`, `is_read`, `created_at`

### ุงูุฎุทูุฉ 3: ุชุถููู ุงููููุงุช

```html
<!-- ูู ุตูุญุฉ ุงูุฏุฑุฏุดุฉ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../../config/supabase-config.js"></script>
<script src="../../assets/js/realtime-chat.js"></script>
```

---

## ๐ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุฌุฏูู `messages`

| ุงูุนููุฏ | ุงูููุน | ุงููุตู |
|--------|-------|-------|
| `id` | UUID | ุงููุนุฑู ุงููุฑูุฏ ููุฑุณุงูุฉ |
| `sender_id` | UUID | ูุนุฑู ุงููุฑุณู |
| `receiver_id` | UUID | ูุนุฑู ุงููุณุชูุจู |
| `match_id` | UUID | ูุนุฑู ุงููุทุงุจูุฉ (ุงููุญุงุฏุซุฉ) |
| `content` | TEXT | ูุญุชูู ุงูุฑุณุงูุฉ |
| `is_read` | BOOLEAN | ุญุงูุฉ ุงููุฑุงุกุฉ |
| `message_type` | VARCHAR(50) | ููุน ุงูุฑุณุงูุฉ (text, image, file) |
| `attachment_url` | TEXT | ุฑุงุจุท ุงููุฑูู |
| `created_at` | TIMESTAMP | ููุช ุงูุฅุฑุณุงู |
| `updated_at` | TIMESTAMP | ููุช ุงูุชุญุฏูุซ |

### ุงูููุงุฑุณ (Indexes)

```sql
-- ููุฃุฏุงุก ุงูุณุฑูุน
idx_messages_match_created (match_id, created_at DESC)
idx_messages_unread (receiver_id, is_read)
idx_messages_realtime (receiver_id, created_at DESC)
```

### ุณูุงุณุงุช ุงูุฃูุงู (RLS Policies)

- ุงููุณุชุฎุฏููู ูููููู ุนุฑุถ ุงูุฑุณุงุฆู ุงูุชู ุฃุฑุณูููุง ุฃู ุงุณุชููููุง ููุท
- ุงููุณุชุฎุฏููู ูููููู ุฅุฑุณุงู ุฑุณุงุฆู ุจุงุณููู ููุท
- ุงููุณุชุฎุฏููู ูููููู ุชุญุฏูุซ ุฑุณุงุฆููู ุงููุฑุณูุฉ
- ุงููุณุชูุจููู ูููููู ุชุญุฏูุซ ุญุงูุฉ ุงููุฑุงุกุฉ

---

## ๐ง ุงูุงุณุชุฎุฏุงู ุงูุจุฑูุฌู

### ุชููุฆุฉ ุงููุธุงู

```javascript
// ูุชู ุชููุงุฆูุงู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
const chatSystem = new RealtimeChatSystem();
await chatSystem.init();
```

### ูุชุญ ูุญุงุฏุซุฉ

```javascript
// ูู ุฃู ููุงู ูู ุงูููุฏ
chatSystem.openConversation(matchId);
```

### ุฅุฑุณุงู ุฑุณุงูุฉ

```javascript
// ุฅุฑุณุงู ุฑุณุงูุฉ ูุตูุฉ
await chatSystem.sendMessage('ูุฑุญุจุงู! ููู ุญุงููุ');

// ูุชู ุชููุงุฆูุงู ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ ุงูุฅุฑุณุงู
```

### ุงูุงุณุชูุงุน ููุฑุณุงุฆู ุงูุฌุฏูุฏุฉ

```javascript
// ูุนูู ุชููุงุฆูุงู ุนุจุฑ Supabase Realtime
// ูุง ุญุงุฌุฉ ููุชุงุจุฉ ููุฏ ุฅุถุงูู
```

---

## ๐ฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ูููู ุงูุตูุญุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ูุงุฆูุฉ ุงููุญุงุฏุซุงุช  โ  ููุทูุฉ ุงูุฏุฑุฏุดุฉ โ
โ                    โ                 โ
โ  โข ูุญุงุฏุซุฉ 1       โ  [ุฑุฃุณ ุงููุญุงุฏุซุฉ]โ
โ  โข ูุญุงุฏุซุฉ 2       โ                 โ
โ  โข ูุญุงุฏุซุฉ 3       โ  [ุงูุฑุณุงุฆู]     โ
โ                    โ                 โ
โ                    โ  [ุญูู ุงูุฅุฏุฎุงู] โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุนูุงุตุฑ ูุงุฆูุฉ ุงููุญุงุฏุซุงุช

- **ุตูุฑุฉ ุงููุณุชุฎุฏู** ูุน ูุคุดุฑ ุงูุงุชุตุงู (ุฃุฎุถุฑ = ูุชุตู)
- **ุงุณู ุงููุณุชุฎุฏู** ูููุช ุขุฎุฑ ุฑุณุงูุฉ
- **ูุนุงููุฉ ุงูุฑุณุงูุฉ** ุงูุฃุฎูุฑุฉ (40 ุญุฑู)
- **ุงููุณุงุฑ** (ูู ูุฏููุฉ โ ุฅูู ูุฏููุฉ)
- **ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ** (ุจุฏุฌ ุฃุญูุฑ)

### ุนูุงุตุฑ ููุทูุฉ ุงูุฏุฑุฏุดุฉ

- **ุฑุฃุณ ุงููุญุงุฏุซุฉ**
  - ุตูุฑุฉ ูุงุณู ุงููุณุชุฎุฏู
  - ุญุงูุฉ ุงูุงุชุตุงู (ูุชุตู/ุบูุฑ ูุชุตู)
  - ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช (ุงุชุตุงูุ ูุงุชุณุงุจุ ุชูุงุตูู)

- **ุงูุฑุณุงุฆู**
  - ููุงุนุงุช ุฑุณุงุฆู (ุฃุฒุฑู ูููุฑุณูุฉุ ุฑูุงุฏู ูููุณุชููุฉ)
  - ููุช ุงูุฅุฑุณุงู
  - ูุคุดุฑ ุงููุฑุงุกุฉ (โ ูุฑุณูุฉุ โโ ููุฑูุกุฉ)

- **ุญูู ุงูุฅุฏุฎุงู**
  - ุตูุฏูู ูุต ูุงุจู ููุชูุฏุฏ
  - ุฒุฑ ุฅุฑุณุงู ุฏุงุฆุฑู ุจุฑุชูุงูู

---

## ๐จ ุงูุชุฎุตูุต

### ุงูุฃููุงู

```css
/* ุงูุฃููุงู ุงูุฃุณุงุณูุฉ */
--primary: #FF6B35
--primary-light: #FF8C42
--success: #4CAF50
--gray: #666
--bg: #f8f9fa

/* ุงูุฑุณุงุฆู ุงููุฑุณูุฉ */
background: linear-gradient(135deg, #FF6B35, #FF8C42)

/* ุงูุฑุณุงุฆู ุงููุณุชููุฉ */
background: white
```

### ุงูุชุฃุซูุฑุงุช

```css
/* ุธููุฑ ุงูุฑุณุงูุฉ */
@keyframes messageAppear {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ุชุญููู ุนูู ุงููุญุงุฏุซุฉ */
.conversation-item:hover {
    background: #f9f9f9;
}
```

---

## ๐ ุงูุฅุดุนุงุฑุงุช

### ุฅุดุนุงุฑุงุช ุงููุชุตูุญ

```javascript
// ุทูุจ ุงูุฅุฐู ุชููุงุฆูุงู
if (Notification.permission === 'default') {
    await Notification.requestPermission();
}

// ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ููู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
new Notification('ุฑุณุงูุฉ ุฌุฏูุฏุฉ', {
    body: 'ูุญุชูู ุงูุฑุณุงูุฉ...',
    icon: '/assets/images/logo.png'
});
```

### ุตูุช ุงูุฅุดุนุงุฑ

```javascript
// ูุชู ุชุดุบูู ุตูุช ุนูุฏ ุงุณุชูุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ
playNotificationSound();
```

---

## ๐ฒ ุงูุชูุงูู ูุน ุงูุฎุฏูุงุช ุงูุฎุงุฑุฌูุฉ

### WhatsApp

```javascript
// ูุชุญ ูุญุงุฏุซุฉ ูุงุชุณุงุจ
openWhatsApp('966500000000');
// ููุชุญ: https://wa.me/966500000000
```

### ุงูุงุชุตุงู ุงููุงุชูู

```javascript
// ุจุฏุก ุงุชุตุงู ูุงุชูู
callUser('966500000000');
// ููุชุญ: tel:966500000000
```

---

## ๐ ุงูุฏูุงู ุงููุณุงุนุฏุฉ ุงููุชุงุญุฉ

### ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

```sql
-- ุงูุญุตูู ุนูู ุนุฏุฏ ุงูุฑุณุงุฆู ุบูุฑ ุงูููุฑูุกุฉ
SELECT get_unread_count('user-uuid-here');

-- ุงูุญุตูู ุนูู ุขุฎุฑ ุฑุณุงูุฉ ูู ูุญุงุฏุซุฉ
SELECT * FROM get_last_message('match-uuid-here');

-- ุชุญุฏูุฏ ุฌููุน ุฑุณุงุฆู ูุญุงุฏุซุฉ ูููุฑูุกุฉ
SELECT mark_conversation_read('match-uuid', 'user-uuid');

-- ุนุฑุถ ุฌููุน ุงููุญุงุฏุซุงุช ูุน ุขุฎุฑ ุฑุณุงูุฉ
SELECT * FROM conversations_with_last_message;
```

### ูู JavaScript

```javascript
// ุชูุณูู ุงูููุช (ูุจู 5 ุฏุ ูุจู 2 ุณุ ...)
formatMessageTime(timestamp);

// ุงุฎุชุตุงุฑ ุงููุต
truncateText(text, maxLength);

// ุงูุชูุฑูุฑ ุฅูู ุฃุณูู ุงูุฏุฑุฏุดุฉ
scrollToBottom();

// ุชุญุฏูุซ ูุคุดุฑุงุช ุงูุงุชุตุงู
updateOnlineIndicators();

// ุนุฑุถ ุชูุจูู
showAlert('ุฑุณุงูุฉ', 'success' | 'error' | 'info');
```

---

## ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก

### ุงูููุงููุณ ุงููููุฉ

- **ุฒูู ุงุณุชุฌุงุจุฉ ุงูุฑุณุงูุฉ**: ูุฌุจ ุฃู ูููู < 500ms
- **ุงุณุชููุงู ุงูุจูุงูุงุช**: ~5KB ููู ุฑุณุงูุฉ
- **ุนุฏุฏ ุงูุงุชุตุงูุงุช Realtime**: ูุงุญุฏ ููู ูุณุชุฎุฏู

### ุงูุชุญุณููุงุช

```javascript
// ุชุญููู 20 ุฑุณุงูุฉ ููุท ูู ุงูุจุฏุงูุฉ
.limit(20)

// ุงุณุชุฎุฏุงู ุงูููุงุฑุณ ููุงุณุชุนูุงูุงุช ุงูุณุฑูุนุฉ
CREATE INDEX idx_messages_match_created ...

// Pagination ูููุญุงุฏุซุงุช ุงูุทูููุฉ
.range(0, 19)
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดุงูู ุงูุดุงุฆุนุฉ

#### 1. ุงูุฑุณุงุฆู ูุง ุชุธูุฑ ููุฑูุงู

**ุงูุญู:**
- ุชุฃูุฏ ูู ุชูุนูู Realtime ูู Supabase Dashboard
- ุชุญูู ูู ูุฌูุฏ `ALTER PUBLICATION supabase_realtime ADD TABLE messages`
- ุงูุญุต Console ููุฃุฎุทุงุก

#### 2. ุฎุทุฃ "window.supabaseClient is undefined"

**ุงูุญู:**
```javascript
// ุชุฃูุฏ ูู ุชุญููู supabase-config.js ูุจู realtime-chat.js
<script src="../../config/supabase-config.js"></script>
<script src="../../assets/js/realtime-chat.js"></script>
```

#### 3. ุงููุณุชุฎุฏู ูุธูุฑ ุฏุงุฆูุงู ุบูุฑ ูุชุตู

**ุงูุญู:**
```sql
-- ุชุฃูุฏ ูู ูุฌูุฏ ุงูุฃุนูุฏุฉ
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS is_online BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS last_seen TIMESTAMP WITH TIME ZONE;
```

#### 4. ุงูุฅุดุนุงุฑุงุช ูุง ุชุนูู

**ุงูุญู:**
```javascript
// ุทูุจ ุงูุฅุฐู ูู ุจุฏุงูุฉ ุงูุฌูุณุฉ
await Notification.requestPermission();
```

---

## ๐ ุงูุฃูุงู

### ุญูุงูุฉ ุงูุจูุงูุงุช

- โ Row Level Security (RLS) ููุนู ุนูู ุฌุฏูู messages
- โ ุงููุณุชุฎุฏููู ูุฑูู ุฑุณุงุฆููู ููุท
- โ ูุง ูููู ุฅุฑุณุงู ุฑุณุงุฆู ุจุฃุณูุงุก ูุณุชุฎุฏููู ุขุฎุฑูู
- โ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูู ูู ุนูููุฉ

### ุฃูุถู ุงูููุงุฑุณุงุช

```javascript
// ุงูุชุญูู ูู ุงููุณุชุฎุฏู ุงููุณุฌู ุฏุงุฆูุงู
if (!this.currentUser) {
    window.location.href = '/pages/auth/login.html';
    return;
}

// ุชูุธูู ุงูุฅุฏุฎุงู
content = content.trim();

// ุงูุชุญูู ูู ุงูุทูู
if (content.length > 5000) {
    throw new Error('ุงูุฑุณุงูุฉ ุทูููุฉ ุฌุฏุงู');
}
```

---

## ๐ ุงูุชุทููุฑุงุช ุงููุณุชูุจููุฉ

### ูููุฒุงุช ูุงุฏูุฉ

- [ ] **ุฅุฑุณุงู ุงูุตูุฑ** - ูุดุงุฑูุฉ ุตูุฑ ุงูุดุญูุงุช
- [ ] **ุงููุฑููุงุช** - PDF ูุงููุณุชูุฏุงุช
- [ ] **ุงูุฑุณุงุฆู ุงูุตูุชูุฉ** - ุชุณุฌูู ุตูุชู
- [ ] **ููุงููุงุช ุงูููุฏูู** - WebRTC
- [ ] **ุงูุชุฑุฌูุฉ ุงูุชููุงุฆูุฉ** - ุนุฑุจู โท ุฅูุฌููุฒู
- [ ] **ุงูุจุญุซ ูู ุงูุฑุณุงุฆู** - ุงูุจุญุซ ุฏุงุฎู ุงููุญุงุฏุซุงุช
- [ ] **ุงูุฃุฑุดูุฉ** - ุฃุฑุดูุฉ ุงููุญุงุฏุซุงุช ุงููุฏููุฉ
- [ ] **ุงูุญุฐู ุงูุชููุงุฆู** - ุญุฐู ุงูุฑุณุงุฆู ุจุนุฏ 90 ูููุงู

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑุงุช ูุฏููุฉ

```javascript
// 1. ุงุฎุชุจุงุฑ ุงูุฅุฑุณุงู
chatSystem.sendMessage('test message');

// 2. ุงุฎุชุจุงุฑ ุงูุงุณุชูุจุงู
// ุงูุชุญ ุงูุตูุญุฉ ูู ูุชุตูุญูู ูุฎุชูููู

// 3. ุงุฎุชุจุงุฑ ุงููุฑุงุกุฉ
// ุงูุชุญ ุงููุญุงุฏุซุฉ - ูุฌุจ ุฃู ุชุชุญุฏุซ is_read ุฅูู true

// 4. ุงุฎุชุจุงุฑ ุงูุฅุดุนุงุฑุงุช
// ุฃุบูู ุงูุชุจููุจ ูุฃุฑุณู ุฑุณุงูุฉ
```

### ุงุฎุชุจุงุฑุงุช ุฃูุชููุงุชูููุฉ

```javascript
// ูุซุงู: ุงุฎุชุจุงุฑ ุชูุณูู ุงูููุช
console.assert(
    chatSystem.formatMessageTime(new Date()) === 'ุงูุขู',
    'ูุดู ุงุฎุชุจุงุฑ ุชูุณูู ุงูููุช'
);
```

---

## ๐ ุงูุฏุนู ุงูููู

### ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ

**ุณ: ููู ุฃุถูู ูุบุงุช ุฅุถุงููุฉุ**  
ุฌ: ุฃุถู ูููุงุช ุชุฑุฌูุฉ ูู `locales/` ูุงุณุชุฎุฏู `document.documentElement.lang`

**ุณ: ูู ูููู ุญุฐู ุงูุฑุณุงุฆูุ**  
ุฌ: ุญุงููุงู ูุงุ ููู ูููู ุฅุถุงูุฉ ููุฒุฉ ุงูุญุฐู ูู ุงููุณุชูุจู

**ุณ: ูู ุนุฏุฏ ุงูุฑุณุงุฆู ุงููุณููุญุ**  
ุฌ: ูุง ููุฌุฏ ุญุฏุ ููู ูููุตุญ ุจุงูุฃุฑุดูุฉ ุจุนุฏ 1000 ุฑุณุงูุฉ

---

## ๐ ุงูููุงุญุธุงุช

- ุงููุธุงู ูุชูุงูู ูุน ุฌููุน ุงููุชุตูุญุงุช ุงูุญุฏูุซุฉ
- ูุชุทูุจ Supabase Pro ููุฅูุชุงุฌ (Realtime)
- ุงุณุชููุงู ุงูุจูุงูุงุช: ~10-50KB/ุฏูููุฉ ุฃุซูุงุก ุงูุฏุฑุฏุดุฉ ุงููุดุทุฉ
- ุงูุชุฃุฎูุฑ: < 500ms ูู ูุนุธู ุงูุฃุญูุงู

---

## ๐ ุงูุฎูุงุตุฉ

ูุธุงู ุฏุฑุฏุดุฉ ููุฑู ูุชูุงูู ูุฌุงูุฒ ููุฅูุชุงุฌ ูุน:
- โ ุชุญุฏูุซุงุช ูุญุธูุฉ
- โ ุชุตููู ุงุญุชุฑุงูู
- โ ุฃูุงู ุนุงูู
- โ ุฃุฏุงุก ููุชุงุฒ
- โ ูุงุจููุฉ ุงูุชูุณุน

**ุชู ุจูุงุคู ุจู โค๏ธ ููููุตุฉ Fast Ship SA**

---

## ๐ ุงูุชุฑุฎูุต

ุฌููุน ุงูุญููู ูุญููุธุฉ ยฉ 2025 Fast Ship SA
